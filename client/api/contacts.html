<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Contact Listing</title>
    <link type="text/css" rel="stylesheet" href="contacts.css">

    <script src="scripts/requireplugins-jquery-1.4.2.js" charset="utf-8"></script>
    <script>
        "use strict";
        /*global require: false, console: false */

        /*
         To detect orientation changes in Android:
         http://stackoverflow.com/questions/1649086/detect-rotation-of-android-phone-in-the-browser-with-javascript
        */

        require(["jquery", "rdapi", "blade/jig", "json2", "iscroll-min"], function ($, rdapi, jig) {
            var scroller, display, cards, cardList, back, header;

            function adjustCardSizes() {
                var cardWidth = display.outerWidth(),
                    cardList = $('.card'),
                    totalWidth = cardWidth * cardList.length,
                    height = window.innerHeight - header.outerHeight();

                //Set height
                display.css('height', height + 'px');

                //Set widths and heights of cards. Need to set the heights
                //explicitly so any card using iscroll will get updated correctly.
                cards.css({
                    width: totalWidth + 'px',
                    height: height + 'px'
                });

                cardList.css({
                    width: cardWidth + 'px',
                    height: height + 'px'
                });
            }

            $(function () {
                //setup for the iscroll thing
                if ('ontouchmove' in document) {
                    document.addEventListener('touchmove', function(e){ e.preventDefault(); }, false);
                    scroller = new iScroll('contactList');
                }
                display = $('#display');
                cards = $('#cards');
                back = $('#back');
                header = $('#header');

                adjustCardSizes();

                //Set the title based on the first card.
                var title = $('.card')[0].getAttribute('title');
                $('#headerText').html(title);

                back.click(function (evt) {
                    cards.css({
                        left: '0px'
                    });
                    back.css('display', 'none');
                });
            });

            //Detect orientation changes and size the card container size accordingly.
            if ('onorientationchange' in window) {
                window.addEventListener('orientationchange', adjustCardSizes, false);
            }
            window.addEventListener('resize', adjustCardSizes, false);

            $('body').delegate('a.person', 'click', function (evt) {
                evt.preventDefault();
                var contact = rdapi.data(evt.target.parentNode.getAttribute('data-blade-jig'));
                rdapi('_design/raindrop!content!all/_view/identities_by_contact', {
                    data: {
                        startkey: JSON.stringify([contact.id[1]]),
                        endkey: JSON.stringify([contact.id[1], {}])
                    },
                    success: function (json) {
                        var idKeys = [];
                        if (json.rows) {
                            json.rows.forEach(function (row) {
                                idKeys.push(['key-schema_id', [row.value.rd_key, 'rd.identity']]);
                            });
                        }

                        console.log(json);
                        rdapi('_design/raindrop!content!all/_view/megaview?reduce=false&include_docs=true', {
                            data: JSON.stringify({
                                keys: idKeys
                            }),
                            processData: false,
                            contentTypeString: 'application/json',
                            type: 'POST',
                            success: function (json) {
                                var identities = [], html = '', options = rdapi.normalizeOptions({
                                    templateId: 'contactDetail'
                                });
                                if (json.rows) {
                                    json.rows.forEach(function (row) {
                                        identities.push(row.doc);
                                    });
                                }
                                if (identities.length) {
                                    contact.identities = identities;
                                }
                                html = jig(options.template, contact, options);

                                $('#identityDisplay').html(html);

                                //Scroll the cards.
                                cards.css({
                                    left: '-' + display.outerWidth() + 'px'
                                });
                                back.css('display', 'block');
                            }
                        });
                    }
                });
            });
        });
    </script>
</head>
<body>
    <div id="header">
        <div id="back">
            <div class="mblArrowButtonHead"></div>
            <div class="mblArrowButtonBody mblArrowButtonText">Back</div>
            <div class="mblArrowButtonNeck"></div>
        </div>
        <span id="headerText"></span>
    </div>

    <div id="display">
        <div id="cards">
            <div id="contactsCard" class="card" title="Contacts">
                <ul id="contactList" class="contacts templateContainer">
                    <li class="template" data-api="inflow/contacts/by_name"><a class="person" href="#{id[1]}">{displayName}</a></li>
                </ul>
            </div>
            <div id="identityDisplay" class="card card2" title="">
            </div>
        </div>
    </div>

    <div class="template" data-id="contactDetail">
        {displayName}
        <ul>
            {identities [}
                <li>
                    {image [}
                        <img src="{}">
                    {]}
                    {name}
                    <ul>
                        {nickname [} <li>Nickname: {}</li> {]}
                    </ul>
                </li>
            {]}
        </ul>
    </div>

</body>
</html>
